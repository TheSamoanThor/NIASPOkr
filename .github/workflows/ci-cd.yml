name: AuthSystem CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  DATABASE_URL: "sqlite:///./test_auth.db"
  SECRET_KEY: "test-secret-key-for-jwt"
  JWT_SECRET: "test-jwt-secret-key"

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install flake8 black
        pip install -r backend/requirements.txt
    
    - name: Check code formatting
      run: |
        echo "Checking code formatting..."
        black --check backend/ || echo "Code formatting issues found"
    
    - name: Check code style
      run: |
        echo "Checking code style..."
        flake8 backend/ --max-line-length=100 --ignore=E203,W503,E501 || echo "Code style issues found"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
    
    - name: Run basic tests
      env:
        DATABASE_URL: ${{ env.DATABASE_URL }}
        SECRET_KEY: ${{ env.SECRET_KEY }}
        JWT_SECRET: ${{ env.JWT_SECRET }}
      run: |
        echo "Running basic tests..."
        cd backend
        
        # Test imports and basic functionality
        python -c "
        try:
            from auth_app import app, db, User
            from user_app import app as user_app
            print('All imports successful')
            
            # Test basic app creation with SQLite
            app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
            app.config['TESTING'] = True
            
            with app.app_context():
                db.create_all()
                print('Database setup successful')
                
                # Test User model
                user = User(
                    name='Test User',
                    email='test@company.com',
                    department='it',
                    employee_id='TEST001',
                    role='user',
                    status='active'
                )
                user.set_password('test123')
                
                # Test password hashing
                assert user.check_password('test123') == True
                assert user.check_password('wrong') == False
                print('Password hashing works')
                
                # Save user to generate IDs and timestamps
                db.session.add(user)
                db.session.commit()
                
                # Test to_dict after save (to avoid None errors)
                user_dict = user.to_dict()
                assert 'id' in user_dict
                assert 'email' in user_dict
                print('User serialization works')
                
        except Exception as e:
            print(f'Test failed: {e}')
            raise
        "
        
        # Test Flask apps start
        python -c "
        from auth_app import app
        app.config['TESTING'] = True
        app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
        
        with app.test_client() as client:
            response = client.get('/health')
            print(f'Health endpoint: {response.status_code}')
        "

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:6-alpine
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
    
    - name: Run integration tests
      env:
        DATABASE_URL: ${{ env.DATABASE_URL }}
        SECRET_KEY: ${{ env.SECRET_KEY }}
        JWT_SECRET: ${{ env.JWT_SECRET }}
        REDIS_HOST: localhost
      run: |
        echo "Running integration tests..."
        cd backend
        
        # Test service initialization with Redis
        python -c "
        from auth_app import app as auth_app
        from user_app import app as user_app
        
        # Configure for testing
        auth_app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
        auth_app.config['TESTING'] = True
        user_app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
        user_app.config['TESTING'] = True
        
        print('Testing auth service with Redis...')
        with auth_app.app_context():
            # Test health endpoint
            with auth_app.test_client() as client:
                response = client.get('/health')
                print(f'Auth health status: {response.status_code}')
        
        print('Testing user service...')
        with user_app.app_context():
            with user_app.test_client() as client:
                response = client.get('/health')
                print(f'User health status: {response.status_code}')
        
        print('Integration tests completed')
        "

  api-tests:
    name: API Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
    
    - name: Run API tests
      env:
        DATABASE_URL: ${{ env.DATABASE_URL }}
        SECRET_KEY: ${{ env.SECRET_KEY }}
        JWT_SECRET: ${{ env.JWT_SECRET }}
      run: |
        echo "Running API tests..."
        cd backend
        
        # Test Auth Service API with SQLite
        python -c "
        from auth_app import app, db, User
        import json
        
        # Configure for testing
        app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
        app.config['TESTING'] = True
        
        with app.app_context():
            db.create_all()
        
        client = app.test_client()
        
        # Test health endpoint
        response = client.get('/health')
        print(f'Health endpoint: {response.status_code}')
        
        # Test registration endpoint
        user_data = {
            'name': 'API Test User',
            'email': 'api_test@company.com',
            'department': 'it',
            'employee_id': 'API001',
            'password': 'testpassword123',
            'confirm_password': 'testpassword123'
        }
        
        response = client.post('/api/auth/register', 
                             data=json.dumps(user_data),
                             content_type='application/json')
        print(f'Registration status: {response.status_code}')
        
        # Test login endpoint
        login_data = {
            'email': 'api_test@company.com',
            'password': 'testpassword123'
        }
        
        response = client.post('/api/auth/login',
                             data=json.dumps(login_data),
                             content_type='application/json')
        print(f'Login status: {response.status_code}')
        
        if response.status_code == 200:
            login_response = response.get_json()
            if 'token' in login_response:
                print('Login successful with token')
        
        print('API tests completed')
        "

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        pip install -r backend/requirements.txt
        pip install bandit safety
    
    - name: Run security tests
      env:
        DATABASE_URL: ${{ env.DATABASE_URL }}
        SECRET_KEY: ${{ env.SECRET_KEY }}
        JWT_SECRET: ${{ env.JWT_SECRET }}
      run: |
        echo "Running security tests..."
        cd backend
        
        # Test password security
        python -c "
        from auth_app import User
        import bcrypt
        
        # Test multiple password scenarios
        test_passwords = [
            'simple123',
            'Complex@Password123!',
            'very_long_password_123456789',
            'short'
        ]
        
        for password in test_passwords:
            test_user = User()
            test_user.set_password(password)
            
            # Verify password hashing
            assert test_user.password_hash is not None
            assert test_user.password_hash != password
            assert len(test_user.password_hash) > 0
            
            # Test correct password verification
            assert test_user.check_password(password) == True
            
            # Test incorrect password rejection
            assert test_user.check_password('wrong_password') == False
            
            print(f'Password security for length {len(password)}: OK')
        
        print('Password security tests passed')
        "
        
        # Test JWT security
        python -c "
        import jwt
        from datetime import datetime, timedelta
        
        # Test token expiration
        payload = {
            'user_id': 1,
            'email': 'test@company.com',
            'exp': datetime.utcnow() - timedelta(hours=1)
        }
        expired_token = jwt.encode(payload, '${{ env.JWT_SECRET }}', algorithm='HS256')
        
        try:
            decoded = jwt.decode(expired_token, '${{ env.JWT_SECRET }}', algorithms=['HS256'])
            print('Expired token should have been rejected')
            assert False
        except jwt.ExpiredSignatureError:
            print('Expired token correctly rejected')
        
        # Test token with wrong secret
        wrong_secret_token = jwt.encode(payload, 'wrong-secret', algorithm='HS256')
        try:
            decoded = jwt.decode(wrong_secret_token, '${{ env.JWT_SECRET }}', algorithms=['HS256'])
            print('Token with wrong secret should have been rejected')
            assert False
        except jwt.InvalidTokenError:
            print('Token with wrong secret correctly rejected')
        
        print('JWT security tests passed')
        "
        
        # Run security scanner
        bandit -r . -f html -o security-report.html || echo "Bandit found issues"
        
        # Check for vulnerable dependencies
        safety check -r requirements.txt || echo "Safety check found issues"

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend image
      run: |
        docker build -t auth-backend:test ./backend

    - name: Build frontend image
      run: |
        docker build -t auth-frontend:test ./frontend

    - name: Test Docker images
      run: |
        echo "Testing backend image..."
        docker run --rm auth-backend:test python -c "import sys; print('Backend image works')"
        
        echo "Testing frontend image..."
        docker run --rm auth-frontend:test nginx -t || echo "Frontend nginx config check"

  test-report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests, api-tests, security-tests, docker-build]
    if: always()
    
    steps:
    - name: Generate test report
      run: |
        echo "# AuthSystem Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| API Tests | ${{ needs.api-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Tests | ${{ needs.security-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## System Overview" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The AuthSystem includes:" >> $GITHUB_STEP_SUMMARY
        echo "- 2 backend services (Auth, User Management)" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend with nginx" >> $GITHUB_STEP_SUMMARY
        echo "- PostgreSQL database" >> $GITHUB_STEP_SUMMARY
        echo "- Redis cache" >> $GITHUB_STEP_SUMMARY
        echo "- Docker containerization" >> $GITHUB_STEP_SUMMARY
        echo "- JWT authentication" >> $GITHUB_STEP_SUMMARY
        echo "- Password hashing with bcrypt" >> $GITHUB_STEP_SUMMARY